<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/iron-ajax/iron-ajax.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/iron-icons/iron-icons.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/iron-icons/social-icons.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/iron-icons/maps-icons.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/iron-icons/device-icons.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/paper-card/paper-card.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/paper-fab/paper-fab.html">

<dom-module id="bof-card">
    <template>
        <style>
            paper-card {
                width: 100%;
            }

            a {
                font-size: inherit;
                font-weight: inherit;
                text-transform: inherit;
                letter-spacing: inherit;
                line-height: inherit;
                text-decoration: underline;
                color: #777;
            }

            span {
                vertical-align: middle;
            }

            paper-fab {
                display: inline-block;
            }

            .heading {
                margin-bottom: 1em;
            }

            .name {
                font-size: 1.75em;
            }

            .action {
                float: right;
                margin-top: -5px;
            }

            .description {
                margin-bottom: 1em;
            }

            .details {
                color: #777;
                font-size: 0.8em;
                margin-bottom: 1em;
            }

            .details-group {
                margin-right: 10px;
            }

            .card-actions {
                padding-top: 10px;
                padding-bottom: 10px;
            }

            paper-fab {
                --paper-fab-background: #fff;
                --paper-fab-keyboard-focus-background: #eee;
                color: #777;
            }

            paper-fab[active] {
                color: red;
            }
        </style>

        <iron-ajax id="joinFlock"
                   url="/api/flocks/[[fid]]/birds"
                   method="POST"
                   handle-as="json"
                   on-response="onJoinLeaveFlockResponse"
                   on-error="onJoinFlockError"></iron-ajax>
         <iron-ajax id="leaveFlock"
                    url="/api/flocks/[[fid]]/birds/self"
                    method="DELETE"
                    handle-as="json"
                    on-response="onJoinLeaveFlockResponse"
                    on-error="onLeaveFlockError"></iron-ajax>

        <paper-card class="bof-card">
            <div class="card-content">
                <div class="heading">
                    <span class="action">
                        <template is="dom-if" if="[[isOwner(leader)]]">
                            <paper-fab mini
                                       on-tap="onEditFlock"
                                       icon="create">Modify this flock</paper-fab>
                            <paper-fab mini
                                       on-tap="onDeleteFlock"
                                       icon="delete">Delete this flock</paper-fab>
                            <paper-fab mini toggles active disabled
                                       icon="favorite-border">You lead this flock</paper-fab>
                        </template>
                        <template is="dom-if" if="[[!isOwner(leader)]]">
                            <paper-fab mini toggles id="joinLeaveButton"
                                       active="[[isBird(birds)]]"
                                       on-tap="onJoinLeaveFlock"
                                       class="fab-button"
                                       icon="favorite-border">Join or leave this flock</paper-fab>
                        </template>
                    </span>
                    <span class="name">[[name]]</span>
                </div>
                <div class="description">[[description]]</div>
            </div>
            <div class="card-actions">
                <div class="details">
                    <span class="details-group">
                <iron-icon icon="device:access-time"></iron-icon>
                <span>[[when]]</span>
                    </span>
                    <span class="details-group">
                <iron-icon icon="maps:place"></iron-icon>
                <span>[[where]]</span>
                    </span>
                    <span class="details-group">
                <iron-icon icon="social:person"></iron-icon>
                <span>
                  <a href="https://github.com/[[leader]]" target="_blank" rel="noopener noreferrer">[[leader]]</a> started the flock</span>
                </span>
                </div>
                <div class="details">
                    <iron-icon icon="social:group"></iron-icon>
                    <template is="dom-if" if="[[birds.length]]">
                        <template is="dom-repeat" items="[[birds]]">
                            <span><a href="https://github.com/[[item]]" target="_blank" rel="noopener noreferrer">[[item]]</a></span>
                        </template>
                    </template>
                    <template is="dom-if" if="[[!birds.length]]">
                        <span>No one in the flock yet</span>
                    </template>
                </div>
            </div>
        </paper-card>
    </template>

    <script>
        Polymer({
            is: 'bof-card',

            properties: {
                name: String,
                description: String,
                leader: String,
                when: String,
                where: String,
                birds: Array,
                fid: String
            },

            isOwner: function(leader) {
                // TODO: replace with authed user info
                return leader === 'nobody';
            },

            isBird: function(birds) {
                // TODO: replace with authed user info
                return birds.indexOf('nobody') !== -1;
            },

            onDeleteFlock: function(evt) {
                this.fire('delete-flock', {
                    fid: this.fid,
                    name: this.name
                });
            },

            onEditFlock: function(evt) {
                this.fire('edit-flock', {
                    fid: this.fid,
                    name: this.name,
                    description: this.description,
                    when: this.when,
                    where: this.where
                });
            },

            onJoinLeaveFlock: function(evt) {
                if(Polymer.dom(evt).localTarget.active) {
                    this.$.joinFlock.generateRequest();
                } else {
                    this.$.leaveFlock.generateRequest();
                }
            },

            onJoinLeaveFlockResponse: function(evt) {
                var flock = Polymer.dom(evt).localTarget.lastResponse;
                this.birds = flock.birds;
            },

            onJoinFlockError: function(err) {
                console.error(err);
                // dom-if wrapped node, need to search for it
                this.$$('#joinLeaveButton').active = false;
                this.fire('error', {
                    text: 'Oops! Trouble joining the flock'
                });
            },

            onLeaveFlockError: function(err) {
                console.error(err);
                this.$$('#joinLeaveButton').active = true;
                this.fire('error', {
                    text: 'Oops! Trouble leaving the flock'
                });
            }
        });
    </script>
</dom-module>
