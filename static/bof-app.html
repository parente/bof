<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/polymer/polymer.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/app-layout/app-header/app-header.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/iron-ajax/iron-ajax.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/iron-icons/iron-icons.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/paper-icon-button/paper-icon-button.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/paper-styles/paper-styles.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/paper-styles/classes/global.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/paper-toast/paper-toast.html">

<link rel="import" href="./bof-card.html">
<link rel="import" href="./bof-editor.html">
<link rel="import" href="./bof-deleter.html">

<dom-module id="bof-app">
    <template>
        <style>
            app-header {
                background-color: #0078ae;
                color: #fff;
            }

            bof-card {
                max-width: 100%;
                width: 600px;
                margin: 10px auto;
                padding: 10px;
                border-radius: 5px;
                overflow: hidden;
            }

            bof-editor {
                max-width: 80%;
                width: 600px;
            }

            .logo {
                height: 50px;
            }

            .engraved {
                margin-top: 2em;
                text-align: center;
                font-size: 28px;
                font-weight: bold;
                background-color: #666;
                -webkit-background-clip: text;
                -moz-background-clip: text;
                background-clip: text;
                color: transparent;
                text-shadow: rgba(255,255,255,0.4) 0px 2px 2px;

            }
        </style>

        <iron-ajax auto id="flockList" url="/api/flocks" handle-as="json" last-response="{{flocks}}"></iron-ajax>

        <app-header-layout>
            <app-header effects="waterfall" fixed>
                <app-toolbar>
                    <img class="logo" src="http://pydata.it/img/logo.png" />
                    <div title>Birds of a Feather</div>
                    <paper-icon-button on-tap="onNewFlock" alt="Start a Flock" icon="add">Start a Flock</paper-icon-button>
                </app-toolbar>
            </app-header>

            <div class="vertical layout">
                <template is="dom-if" if="[[flocks.results.length]]">
                    <template is="dom-repeat" items="[[flocks.results]]">
                        <bof-card fid="[[item.id]]"
                                  name="[[item.name]]"
                                  description="[[item.description]]"
                                  when="[[item.when]]"
                                  where="[[item.where]]"
                                  leader="[[item.leader]]"
                                  birds="[[item.birds]]"
                                  username="[[username]]"
                                  on-edit-flock="onEditFlock"
                                  on-delete-flock="onDeleteFlock"
                                  on-error="onError"></bof-card>
                    </template>
                </template>
                <template is="dom-if" if="[[!flocks.results.length]]">
                    <p class="engraved">No flocks yet.<br />Want to fly first?</p>
                </template>
            </div>
        </app-header-layout>

        <bof-editor id="flockEditor" on-commit="onCommit" on-error="onError"></bof-editor>
        <bof-deleter id="flockDeleter" on-commit="onCommit" on-error="onError"></bof-deleter>

        <paper-toast id="burntToast"></paper-toast>
    </template>

    <script>
        Polymer({
            is: 'bof-app',
            properties: {
                username: String
            },

            onNewFlock: function() {
                if(!this.username) {
                    // TODO: show dialog first
                    window.location = '/api/auth/github';
                } else {
                    // TODO: is there a better way to do this en masse?
                    this.$.flockEditor.fid = '';
                    this.$.flockEditor.name = '';
                    this.$.flockEditor.description = '';
                    this.$.flockEditor.when = '';
                    this.$.flockEditor.where = '';
                    this.$.flockEditor.opened = true;
                }
            },

            onEditFlock: function(evt) {
                var flock = evt.detail;
                this.$.flockEditor.fid = flock.fid;
                this.$.flockEditor.name = flock.name;
                this.$.flockEditor.description = flock.description;
                this.$.flockEditor.when = flock.when;
                this.$.flockEditor.where = flock.where;
                this.$.flockEditor.opened = true;
            },

            onDeleteFlock: function(evt) {
                var flock = evt.detail;
                this.$.flockDeleter.fid = flock.fid;
                this.$.flockDeleter.name = flock.name;
                this.$.flockDeleter.opened = true;
            },

            onCommit: function(evt) {
                this.$.flockList.generateRequest();
            },

            onError: function(evt) {
                this.$.burntToast.text = evt.detail.text;
                this.$.burntToast.opened = true;
            }
        });
    </script>
</dom-module>
