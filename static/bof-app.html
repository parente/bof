<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/polymer/polymer.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/paper-button/paper-button.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/paper-dialog/paper-dialog.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/paper-input/paper-input.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/iron-ajax/iron-ajax.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/iron-form/iron-form.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/iron-icons/iron-icons.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/paper-icon-button/paper-icon-button.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/app-layout/app-header/app-header.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/paper-styles/paper-styles.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.5.0/lib/paper-styles/classes/global.html">

<link rel="import" href="./bof-card.html">

<dom-module id="bof-app">
    <template>
        <style>
            app-header {
                background-color: #0078ae;
                color: #fff;
            }

            .logo {
                height: 50px;
            }

            paper-dialog {
                max-width: 80%;
                width: 600px;
            }
        </style>

        <iron-ajax auto id="flockList" url="/api/flocks" handle-as="json" last-response="{{flocks}}"></iron-ajax>

        <app-header-layout>
            <app-header effects="waterfall" fixed>
                <app-toolbar>
                    <img class="logo" src="http://pydata.it/img/logo.png" />
                    <div title>Birds of a Feather</div>
                    <paper-icon-button on-tap="onNewFlock" icon="add-circle-outline">Start a Flock</paper-icon-button>
                </app-toolbar>
            </app-header>

            <div class="vertical layout">
                <template is="dom-repeat" items="[[flocks.results]]">
                    <bof-card id="[[item.id]]"
                              name="[[item.name]]"
                              description="[[item.description]]"
                              when="[[item.when]]"
                              where="[[item.where]]"
                              leader="[[item.leader]]"
                              birds="[[item.birds]]"></bof-card>
                </template>
            </div>
        </app-header-layout>

        <form is="iron-form"
              id="flockForm"
              on-iron-form-response="onNewFlockResponse"
              on-iron-form-error="onNewFlockError"
              method="post" action="/api/flocks"
              content-type="application/json">
            <paper-dialog id="flockDialog" modal>
                <h2>Start a Flock</h2>
                <paper-dialog-scrollable>
                    <paper-input name="name"
                                 label="Name your flock"
                                 maxlength="128"
                                 char-counter autofocus required></paper-input>
                    <paper-input name="description"
                                 label="Describe the topic"
                                 maxlength="256"
                                 char-counter required></paper-input>
                    <paper-input name="when"
                                 label="When do you want to meet?"
                                 maxlength="128"
                                 char-counter required></paper-input>
                    <paper-input name="where"
                                 label="Where do you want to meet?"
                                 maxlength="128"
                                 char-counter required></paper-input>
                </paper-dialog-scrollable>
                <div class="buttons">
                    <paper-button dialog-dismiss>Cancel</paper-button>
                    <paper-button on-tap="onSubmitNewFlockRequest">Submit</paper-button>
                </div>
            </paper-dialog>
        </form>
    </template>

    <script>
        Polymer({
            is: 'bof-app',

            onNewFlock: function() {
                this.$.flockDialog.opened = true;
            },

            onSubmitNewFlockRequest: function(evt) {
                evt.preventDefault();
                this.$.flockForm.submit();
            },

            onNewFlockResponse: function(evt) {
                this.$.flockForm.reset();
                this.$.flockDialog.opened = false;
                this.$.flockList.generateRequest();
            },

            onNewFlockError: function(evt) {
                // TODO: show user errors in dialog
                console.error(evt);
            }
        });
    </script>
</dom-module>
